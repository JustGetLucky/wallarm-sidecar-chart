name: Integration test

on:
  push:
    branches: [ "main", "helm-chart", "github-actions" ]
    tags:
      - '**'
#  pull_request:
#    branches: [ "main" ]
#
#
  workflow_dispatch:

env:
  KUBEVAL_SCHEMA_LOCATION: 'https://raw.githubusercontent.com/yannh/kubernetes-json-schema/master/'

jobs:
  lint:
    name: Integration test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Prepare Kind cluster
        uses: helm/kind-action@v1.3.0
        with:
          verbosity: 3
          wait: "240s"

      - name: Check Kind cluster
        run: |
          kubectl cluster-info
          kubectl get pods -n kube-system
          echo "current-context:" $(kubectl config current-context)
          echo "environment-kubeconfig:" ${KUBECONFIG}

      - name: Helm install
        run: |
          helm version
           helm install wallarm-sidecar . --namespace wallarm-sidecar --create-namespace --wait --debug

      - name: Check Helm installation
        run: |
          helm list --namespace wallarm-sidecar
          kebectl get all --namespace wallarm-sidecar -o yaml
