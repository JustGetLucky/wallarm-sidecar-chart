name: Integration test

on:
  push:
    branches: [ "main", "helm-chart", "github-actions" ]
    tags:
      - '**'
#  pull_request:
#    branches: [ "main" ]
#
#
  workflow_dispatch:


jobs:
  lint:
    name: Integration test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Prepare Kind cluster
        uses: helm/kind-action@v1.3.0
        with:
          verbosity: "0"
          wait: "240s"

      - name: Check Kind cluster
        run: |
          kubectl cluster-info
          kubectl wait --for=condition=Ready pods --all -n kube-system
          echo "current-context:" $(kubectl config current-context)
          echo "environment-kubeconfig:" ${KUBECONFIG}

      - name: Install Helm chart
        run: |
          helm version
          helm install wallarm-sidecar . \
          --set wallarmApi.host=audit.api.wallarm.com \
          --set wallarmApi.token=${{ secrets.WALLARM_TOKEN }} \
          --namespace wallarm-sidecar \
          --create-namespace \
          --wait

      - name: Check Helm installation
        run: |
          helm list --namespace wallarm-sidecar
          kubectl get all --namespace wallarm-sidecar

      - name: Deploy test application
        run: |
          echo "\nDeploying app ..."
          kubectl apply -k test/app/base
          echo "\nWait for pods to be rady ..."
          kubectl wait --for=condition=Ready pods --all -n default
          echo "\nApp resources deployed:"
          kubectl get all -n default
