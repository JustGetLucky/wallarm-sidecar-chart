{{- define "environmentVariables"  }}
   - name: WALLARM_API_HOST
     value: {{ .Config.Api.host }}
   - name: WALLARM_API_PORT
     value: {{ .Config.Api.port }}
   - name: WALLARM_API_TOKEN
     value: {{ .Config.Api.token }}
   - name: WALLARM_API_USE_SSL
     value: {{ .Config.Api.useSSL }}
   - name: WALLARM_API_CA_VERIFY
     value: {{ .Config.Api.caVerify }}
   - name: WALLARM_MODE
     value: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/wallarm-mode" .Config.Wallarm.mode }}
   - name: NGINX_PORT
     value: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/wallarm-proxy-port" .Config.Wallarm.proxyPort }}
   - name: NGINX_BACKEND
     value: "127.0.0.1:{{ getAnnotation .ObjectMeta 'sidecar.wallarm.io/wallarm-app-port' .Config.Wallarm.appPort}}"
  - name: POSTANALYTIC_ADDRESS
    value: {{ .Config.Wallarm.tarantool.host }}
  {{ if (isSet .ObjectMeta.Annotations "sidecar.wallarm.io/wallarm-app-id") -}}
  - name: WALLARM_APPLICATION
    value: {{ index .ObjectMeta.Annotations "sidecar.wallarm.io/wallarm-app-id" }}
  {{- end  }}
{{- end  }}

initContainers:
volumes:
containers:
  - name: wallarm-sidecar
    image: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/proxy-image" .Config.Container.image }}
    imagePullPolicy: IfNotPresent
    env:
    {{- template "environmentVariables" . }}
    ports:
      - containerPort: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/wallarm-proxy-port" .Config.Wallarm.proxyPort }}
    livenessProbe:
      tcpSocket:
        port: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/wallarm-proxy-port" .Config.Wallarm.proxyPort }}
    resources:
      requests:
        cpu: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/proxy-cpu" .Config.Container.resources.requests.cpu }}
        memory: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/proxy-memory" .Config.Container.resources.requests.memory }}
      limits:
        cpu: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/proxy-cpu-limit" .Config.Container.resources.limits.cpu }}
        memory: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/proxy-memory-limit" .Config.Container.resources.limits.memory }}