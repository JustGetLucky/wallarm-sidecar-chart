initContainers:
  - name: sidecar-init
    image: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/init-image" .Config.Container.init.image.image }}
    imagePullPolicy: {{ .Config.Container.init.image.pullPolicy }}
    env:
      - name: POD_IP
        valueFrom:
          fieldRef:
            fieldPath: status.podIP
      - name: APP_PORT
        value: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/wallarm-app-port" .Config.Wallarm.appPort}}
      - name: PROXY_PORT
        value: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/wallarm-proxy-port" .Config.Wallarm.proxyPort }}
    command: ["iptables"]
    args: ["-t", "nat", "-A", "PREROUTING", "-p", "tcp", "-d", "$(POD_IP)", "--dport", "$(APP_PORT)", "-j", "REDIRECT", "--to-ports", "$(PROXY_PORT)"]
    securityContext:
      capabilities:
        add:
        - NET_ADMIN
        drop:
        - ALL
      privileged: true
    resources:
      requests:
        cpu: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/init-cpu" .Config.Container.init.resources.requests.cpu }}
        memory: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/init-memory" .Config.Container.init.resources.requests.memory }}
      limits:
        cpu: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/init-cpu-limit" .Config.Container.init.resources.limits.cpu }}
        memory: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/init-memory-limit" .Config.Container.init.resources.limits.memory }}


containers:
  - name: sidecar-proxy
    image: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/proxy-image" .Config.Container.proxy.image.image }}
    imagePullPolicy: {{ .Config.Container.proxy.image.pullPolicy }}
    env:
      - name: WALLARM_API_HOST
        value: {{ .Config.Api.host }}
      - name: WALLARM_API_PORT
        value: {{ .Config.Api.port }}
      - name: WALLARM_API_TOKEN
        value: {{ .Config.Api.token }}
      - name: WALLARM_API_USE_SSL
        value: {{ .Config.Api.useSSL }}
      - name: WALLARM_API_CA_VERIFY
        value: {{ .Config.Api.caVerify }}
      - name: WALLARM_MODE
        value: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/wallarm-mode" .Config.Wallarm.mode }}
      - name: NGINX_PORT
        value: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/wallarm-proxy-port" .Config.Wallarm.proxyPort }}
      - name: NGINX_BACKEND
        value: "127.0.0.1:{{ getAnnotation .ObjectMeta `sidecar.wallarm.io/wallarm-app-port` .Config.Wallarm.appPort}}"
      - name: POSTANALYTIC_ADDRESS
        value: {{ .Config.Wallarm.tarantool.host }}
      {{ if (isSet .ObjectMeta.Annotations "sidecar.wallarm.io/wallarm-app-id") -}}
      - name: WALLARM_APPLICATION
        value: {{ index .ObjectMeta.Annotations "sidecar.wallarm.io/wallarm-app-id" }}
      {{- end  }}
    livenessProbe:
      tcpSocket:
        port: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/wallarm-proxy-port" .Config.Wallarm.proxyPort }}
      {{ toYaml .Config.Container.proxy.livenessProbe | indent 6 }}
    ports:
      - name: proxy
        containerPort: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/wallarm-proxy-port" .Config.Wallarm.proxyPort }}
        protocol: TCP
    resources:
      requests:
        cpu: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/proxy-cpu" .Config.Container.proxy.resources.requests.cpu }}
        memory: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/proxy-memory" .Config.Container.proxy.resources.requests.memory }}
      limits:
        cpu: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/proxy-cpu-limit" .Config.Container.proxy.resources.limits.cpu }}
        memory: {{ getAnnotation .ObjectMeta "sidecar.wallarm.io/proxy-memory-limit" .Config.Container.proxy.resources.limits.memory }}

volumes: